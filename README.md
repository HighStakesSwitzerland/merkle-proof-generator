merkle-proof-generator
==================

## Installation

```shell
npm install && npm pack
```

Compiled script will be placed to `./bin/run`

File `merkle-proof-generator-1.0.0.tgz` is of no use

## Usage

Global help
```
./bin/run --help
```

## Airdrop file format

See example file in testdata/airdrop_file.json
```json
[
  { "address": "secret1k9hwzxs889jpvd7env8z49gad3a3633vg350tq", "amount": "100"},
  { "address": "secret1uy9ucvgerneekxpnfwyfnpxvlsx5dzdpf0mzjd", "amount": "1010"},
  ...
]
```

## Commands

**Generate Root:**
```shell
./bin/run generateRoot --file ./testdata/airdrop_file.json
# command output:
Root Hash: b45c1ea28b26adb13e412933c9e055b01fdf7585304b00cd8f1cb220aa6c5e88
```
Hash must be uploaded to IBEX Smart Contract using command
```
secretcli tx compute execute <contract-address> \
'{"register_merkle_root": { \
    "merkle_root": "b45c1ea28b26adb13e412933c9e055b01fdf7585304b00cd8f1cb220aa6c5e88" # hash goes here,
        "expiration": # Expiration in format TBD,
        "start": # Expiration in format TBD,
        "total_amount": 1110 \ #the total amount of this weekly airdrop
    } \
}' --from <admin_account> # only admin account is allowed to execute this tx
```

**Generate proof:**

This is for users (same code is on the website in javascript). File `./testdata/airdrop_file.json` must be also in website `/assets/` folder

Implementation is here for testing:
```shell
./bin/run generateProofs --file ./testdata/airdrop_file.json \
  --address wasm1k9hwzxs889jpvd7env8z49gad3a3633vg350tq \
  --amount 100
# commande output:
[
  'a714186eaedddde26b08b9afda38cf62fdf88d68e3aa0d5a4b55033487fe14a1',
  'fb57090a813128eeb953a4210dd64ee73d2632b8158231effe2f0a18b2d3b5dd',
  'c30992d264c74c58b636a31098c6c27a5fc08b3f61b7eafe2a33dcb445822343'
]
```
The array of 3 (or more) hash is signed by Keplr and sent to the smart contract.

The contract validates the wallet address and the hashes. If valid, the transfer of IBEX is executed in the same TX.

**Verify proof:**

This part is done by the smart contract.

Implementation is here for testing:
```shell
PROOFS='["a714186eaedddde26b08b9afda38cf62fdf88d68e3aa0d5a4b55033487fe14a1","fb57090a813128eeb953a4210dd64ee73d2632b8158231effe2f0a18b2d3b5dd","c30992d264c74c58b636a31098c6c27a5fc08b3f61b7eafe2a33dcb445822343"]'
./bin/run verifyProofs --file ./testdata/airdrop_file.json \
  --address wasm1ylna88nach9sn5n7qe7u5l6lh7dmt6lp2y63xx \
  --amount 100 \
  --proofs $PROOFS
# command output:
true # or false if something has been tampered with
```

Equivalent for smart contract:
```
secretcli tx compute execute <contract-address> \
  '{"claim_airdrop": { \
      "stage": "1", # the stage is automatically incremented on executing register_merkle_root command, it must match
      "amount": "100",
      "proof": "['a71418...', '...', '...']",
      "sig_info": # signature is generated by keplr \
    }' --from user_account

```
